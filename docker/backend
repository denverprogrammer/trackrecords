FROM python:3.12-rc-alpine3.16 as base

# do not write pyc files
ENV PYTHONDONTWRITEBYTECODE 1
# prevent buffering stdout and stderr
ENV PYTHONUNBUFFERED 1
# enable Python tracebacks on segfaults
ENV PYTHONFAULTHANDLER 1
# set locale
ENV LANG C.UTF-8
ENV LC_ALL C.UTF-8

FROM base as dependencies

COPY Pipfile* /
WORKDIR /

RUN apk update \
    && apk add --no-cache postgresql-libs \
    && apk add --no-cache --virtual .build-deps gcc musl-dev postgresql-dev \
    && pip install --upgrade pip \
    && pip install pipenv \
    && pipenv install --system --deploy

FROM base as compiled

RUN apk update \
    && apk add libpq \
    && mkdir -p /home/backend

COPY --from=dependencies /usr/local /usr/local

ADD ./scripts/entrypoint.sh /home/scripts/entrypoint.sh
RUN chmod 755 /home/scripts/entrypoint.sh

COPY ./ /home/backend
WORKDIR /home/backend

ENTRYPOINT ["/bin/sh", "/home/scripts/entrypoint.sh"]

# ENTRYPOINT ["tail", "-f", "/dev/null"]
